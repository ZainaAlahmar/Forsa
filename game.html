<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Hero Code: The Rescue</title>
        <style>
    @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Cairo:wght@700&display=swap');

    :root {
        --pixel-green: #4da86e;
        --pixel-yellow: #ffd700;
        --ui-bg: rgba(10, 12, 15, 0.98);
        --pixel-red: #ff4444;
        --pixel-pink: #ff8da1;
    }

    body {
        margin: 0; background-color: #000; color: white;
        font-family: 'Press Start 2P', 'Cairo', cursive;
        display: flex; justify-content: center; align-items: center;
        height: 100vh; overflow: hidden;
    }

    #game-container {
        width: 1000px; height: 95vh; max-height: 900px;
        border: 8px solid #333; position: relative;
        background-color: #000; display: flex; flex-direction: column;
    }

    #scene {
        flex: 1; position: relative; border-bottom: 6px solid var(--pixel-green);
        overflow: hidden; 
        background-size: 1000px 100%; 
        background-repeat: repeat-x;
        background-position: 0 0;
        transition: background-image 0.5s ease-in-out;
    }

    .bg-room     { background-image: url('room.png'); } 
    .bg-cave     { background-image: url('cave.png'); } 
    .bg-loope    { background-image: url('loope.png'); }
    .bg-mountain { background-image: url('mountain.png'); }
    .bg-volcano  { background-image: url('volcano.png'); }
    .bg-castle   { background-image: url('castle.png'); } 

    .scrolling { animation: scrollBackground 2s linear infinite; }
    
    @keyframes scrollBackground {
        from { background-position: 0 0; }
        to { background-position: -1000px 0; }
    }

    .flying { animation: flyUpDown 1.5s ease-in-out infinite; }
    @keyframes flyUpDown {
        0%, 100% { transform: translateY(0); }
        50% { transform: translateY(-30px); }
    }

    .walking-knight { animation: bob 0.4s infinite; }
    @keyframes bob { 
        0%, 100% { transform: translateY(0); } 
        50% { transform: translateY(-15px); } 
    }

    @keyframes jump { 
        0% { transform: translateY(0); } 
        50% { transform: translateY(-100px); } 
        100% { transform: translateY(0); } 
    }
    .hero-jump { animation: jump 0.5s ease-in-out; }

    @keyframes slideInSage { 
        from { right: -350px; } 
        to { right: 150px; } 
    }

    .character {
        position: absolute; bottom: 10px; 
        width: 300px; height: 300px;
        background-size: contain; background-repeat: no-repeat;
        background-position: bottom; 
        transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275), filter 0.5s;
        image-rendering: pixelated;
    }

    #hero     { left: 80px; background-image: url('hero.png'); z-index: 10; }
    #enemy    { right: 80px; background-image: url('troll.png'); display: none; }
    #princess { right: 150px; background-image: url('princess.png'); display: none; }
    
    #sage { 
        right: -350px; bottom: 40px; width: 220px; height: 220px; 
        z-index: 15; background-image: url('helper.png'); 
        display: none; 
    }

    .fallen { 
        filter: grayscale(100%) brightness(50%) !important; 
        z-index: 1; 
    }

    #hero.fallen {
        transform: rotate(-90deg) translateY(120px) !important;
    }

    #enemy.fallen {
        transform: rotate(90deg) translateY(120px) !important;
    }

    #ui-panel { 
        height: 380px; background-color: var(--ui-bg); 
        padding: 25px; display: flex; flex-direction: column; 
        border-top: 4px solid var(--pixel-yellow); position: relative; 
    }

    #hearts-display {
        width: 150px; height: 50px;
        background-size: contain; background-repeat: no-repeat;
        image-rendering: pixelated; margin-bottom: 10px;
    }

    #speaker { color: var(--pixel-yellow); margin-bottom: 10px; font-size: 16px; font-weight: bold; }
    #story-text { font-size: 14px; line-height: 1.8; height: 100px; overflow-y: auto; }
    
    #hint-text { 
        color: var(--pixel-pink); font-size: 11px; margin-top: 10px; 
        min-height: 80px; padding-left: 10px; line-height: 1.5;
        display: flex; flex-direction: column; gap: 8px;
    }

    #input-area { display: none; gap: 10px; margin-top: auto; padding-bottom: 10px; }
    #final-buttons { display: none; gap: 20px; margin-top: auto; padding-bottom: 10px; justify-content: center; }
    
    input { 
        flex-grow: 1; padding: 18px; background: #000; 
        border: 4px solid var(--pixel-green); color: var(--pixel-yellow); 
        font-family: inherit; outline: none; 
    }
    
    button { 
        padding: 12px 25px; background: var(--pixel-green); 
        border: none; color: white; font-family: inherit; 
        cursor: pointer; transition: transform 0.1s;
    }
    button:active { transform: scale(0.95); }

    #intro-btn { 
        align-self: center; margin: auto auto 20px auto;
        padding: 10px 25px; font-size: 12px; min-width: 150px;
    }

    @keyframes shake {
        0% { transform: translate(1px, 1px) rotate(0deg); }
        10% { transform: translate(-1px, -2px) rotate(-1deg); }
        20% { transform: translate(-3px, 0px) rotate(1deg); }
        30% { transform: translate(3px, 2px) rotate(0deg); }
        40% { transform: translate(1px, -1px) rotate(1deg); }
        50% { transform: translate(-1px, 2px) rotate(-1deg); }
        60% { transform: translate(-3px, 1px) rotate(0deg); }
        70% { transform: translate(3px, 1px) rotate(-1deg); }
        80% { transform: translate(-1px, -1px) rotate(1deg); }
        90% { transform: translate(1px, 2px) rotate(0deg); }
        100% { transform: translate(1px, -2px) rotate(-1deg); }
    }

    .shake-screen {
        animation: shake 0.5s;
        animation-iteration-count: 1;
    }

    .settings-btn { 
        position: absolute; top: 20px; right: 20px; z-index: 200; 
        padding: 10px; font-size: 10px; background: rgba(0,0,0,0.7); 
        border: 2px solid white; color: white; cursor: pointer; 
    }
    
    .overlay { 
        position: absolute; top:0; left:0; width:100%; height:100%; 
        background: rgba(0,0,0,0.95); z-index: 100; 
        display: flex; flex-direction: column; 
        justify-content: center; align-items: center; text-align: center; 
    }
    
    .hidden { display: none !important; }
    .rtl { direction: rtl; font-family: 'Cairo', sans-serif; text-align: right; }
  
    .rtl #hint-text {
        font-size: 15px !important; 
        font-weight: bold;
        line-height: 1.6;
        padding-right: 10px;
        padding-left: 0;
    }

</style>
    </head>
    <body>

        <div id="game-container">
            <button id="main-settings-btn" class="settings-btn"
                onclick="openSettings()"> SETTINGS</button>

            <div id="settings-window" class="overlay hidden">
                <h2 id="settings-title"
                    style="color:var(--pixel-yellow); margin-bottom: 30px;">PAUSED
                    / SETTINGS</h2>
                <div
                    style="display:flex; flex-direction:column; gap: 15px; width: 250px;">
                    <button id="modal-mute-btn" onclick="toggleMute()">ğŸ”Š SOUND:
                        ON</button>
                    <button id="modal-exit-btn" onclick="askExit()"
                        style="background-color: var(--pixel-red);">EXIT
                        GAME</button>
                    <button id="modal-resume-btn" onclick="closeSettings()"
                        style="background-color: #555; margin-top: 10px;">RESUME</button>
                </div>
            </div>

            <div id="confirm-window" class="overlay hidden">
                <h2 id="confirm-text"
                    style="color:white; margin-bottom: 20px; font-size: 14px; line-height: 1.5; max-width: 80%;">
                    ARE YOU SURE YOU WANT TO EXIT THE GAME?
                </h2>
                <div style="display:flex; gap: 20px;">
                    <button id="confirm-yes-btn" onclick="realExit()"
                        style="background-color: var(--pixel-red);">YES</button>
                    <button id="confirm-no-btn" onclick="closeConfirm()"
                        style="background-color: #555;">NO</button>
                </div>
            </div>

            <div id="start-screen" class="overlay">
                <h1 style="color:var(--pixel-yellow); margin-bottom: 40px;">CODE
                    HERO</h1>
                <div style="display:flex; gap: 20px;">
                    <button onclick="startGame('en')">ENGLISH</button>
                    <button onclick="startGame('ar')"
                        style="font-family:'Cairo'">Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</button>
                </div>
            </div>

            <div id="level-window" class="overlay hidden">
                <h2 id="level-title"
                    style="color:var(--pixel-yellow); font-size: 22px; max-width: 80%; line-height: 1.6;">MISSION
                    STARTING</h2>
                <button id="level-btn" style="margin-top: 30px;"
                    onclick="closeLevelWindow()">CONTINUE</button>
            </div>

            <div id="lose-window" class="overlay hidden">
                <h1 id="lose-title"
                    style="color:var(--pixel-red); margin-bottom: 20px;">YOU
                    LOST!</h1>
                <p id="lose-text"
                    style="margin-bottom: 40px; font-size: 12px;">Try again to
                    rescue the princess!</p>
                <div style="display:flex; gap: 20px;">
                    <button id="lose-try-btn" onclick="location.reload()">TRY
                        AGAIN</button>
                    <button id="lose-exit-btn" style="background-color: #555;"
                        onclick="exitGame()">EXIT</button>
                </div>
            </div>

            <div id="scene" class="bg-room">
                <div id="top-bar" style="padding:20px;">HP: <div
                        id="hearts-display"></div></div>
                <div id="hero" class="character"></div>
                <div id="enemy" class="character"></div>
                <div id="princess" class="character"></div>
                <div id="sage" class="character"></div>
            </div>

            <div id="ui-panel">
                <div id="speaker">SYSTEM:</div>
                <div id="story-text">...</div>
                <div id="hint-text"></div>

                <div id="input-area">
                    <input type="text" id="player-input"
                        placeholder="Type answer...">
                    <button id="attack-btn"
                        onclick="handleAction()">ATTACK</button>
                </div>

                <div id="final-buttons">
                    <button id="replay-btn"
                        onclick="location.reload()">REPLAY</button>
                    <button id="exit-btn" style="background-color: #555;"
                        onclick="exitGame()">EXIT</button>
                </div>

                <button id="intro-btn" class="hidden"
                    onclick="triggerMissionStart()">OK, LET'S GO!</button>
            </div>
        </div>

        <script>
        let lang = 'en';
        const params = new URLSearchParams(window.location.search);
        let stage = 0; let subStep = 0; let hp = 3;
        let isAnimating = false; let talkStep = 0;
        let isMuted = false;
        let audioCtx = null;
        let gainNode = null;

        const translations = {
            en: { 
                system: "SYSTEM:", wizard: "WIZARD:", giant: "MONSTER:", princess: "PRINCESS:", 
                go: "OK, LET'S GO!", walking: "Running deeper into the cave...", 
                attack: "ATTACK", replay: "REPLAY", exit: "EXIT",
                level1: "MISSION STARTING: LEVEL 1",
                level2: "GREAT WORK! I BELIEVE IN YOU!: LEVEL 2",
                level3: "GETTING CLOSER TO THE PRINCESS!: LEVEL 3",
                level4: "ONE MORE ENEMY TO DEFEAT!: LEVEL 4",
                h1_label: "HINT: ", h2_label: "SAGE ADVICE: ", h3_label: "FINAL CLUE: ",
                next: "NEXT >",
                loseTitle: "YOU LOST!",
                loseMsg: "Try again to rescue the princess!",
                tryAgain: "TRY AGAIN",
                settingsBtn: " SETTINGS",
                settingsTitle: "PAUSED / SETTINGS",
                soundOn: "ğŸ”Š SOUND: ON",
                soundOff: "ğŸ”‡ SOUND: OFF",
                resume: "RESUME",
                exitGame: "EXIT GAME",
                confirmExit: "ARE YOU SURE YOU WANT TO EXIT THE GAME?",
                yes: "YES",
                no: "NO"
            },
            ar: { 
                system: ":Ø§Ù„Ù†Ø¸Ø§Ù…", wizard: ":Ø§Ù„Ø³Ø§Ø­Ø±", giant: ":Ø§Ù„ÙˆØ­Ø´", princess: ":Ø§Ù„Ø£Ù…ÙŠØ±Ø©", 
                go: "!Ù„Ù†Ù†Ø·Ù„Ù‚", walking: "...Ø§Ù„Ø±ÙƒØ¶ Ø¯Ø§Ø®Ù„ Ø§Ù„ÙƒÙ‡Ù", 
                attack: "Ù‡Ø¬ÙˆÙ…", replay: "Ø¥Ø¹Ø§Ø¯Ø©", exit: "Ø®Ø±ÙˆØ¬",
                level1: "Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ù‡Ù…Ø©: Ø§Ù„Ù…Ø³ØªÙˆÙ‰ 1",
                level2: " Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø«Ø§Ù†ÙŠ : Ø¹Ù…Ù„ Ø±Ø§Ø¦Ø¹ !Ø£Ù†Ø§ Ø£ÙˆÙ…Ù† Ø¨Ùƒ",
                level3: " !Ø£Ù†Øª ØªÙ‚ØªØ±Ø¨ Ù…Ù† Ø§Ù„Ø£Ù…ÙŠØ±Ø©",
                level4: "!Ø¨Ù‚ÙŠ Ø¹Ø¯Ùˆ ÙˆØ§Ø­Ø¯ Ù„Ù‡Ø²ÙŠÙ…ØªÙ‡",
                h1_label: "ØªÙ„Ù…ÙŠØ­: ", h2_label: "Ù†ØµÙŠØ­Ø© Ø§Ù„Ø­ÙƒÙŠÙ…: ", h3_label: "Ø§Ù„Ø¯Ù„ÙŠÙ„ Ø§Ù„Ø£Ø®ÙŠØ±: ",
                next: "Ø§Ù„ØªØ§Ù„ÙŠ >",
                loseTitle: "!Ù„Ù‚Ø¯ Ø®Ø³Ø±Øª",
                loseMsg: "Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ Ù„Ø¥Ù†Ù‚Ø§Ø° Ø§Ù„Ø£Ù…ÙŠØ±Ø©!",
                tryAgain: "Ø­Ø§ÙˆÙ„ Ù…Ø¬Ø¯Ø¯Ø§Ù‹",
                settingsBtn: " Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª",
                settingsTitle: "ØªÙ… Ø§Ù„Ø¥ÙŠÙ‚Ø§Ù / Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª",
                soundOn: "ğŸ”Š Ø§Ù„ØµÙˆØª: Ù…ÙØ¹Ù„",
                soundOff: "ğŸ”‡ Ø§Ù„ØµÙˆØª: Ù…Ø¹Ø·Ù„",
                resume: "Ø§Ø³ØªØ¦Ù†Ø§Ù",
                exitGame: "Ø®Ø±ÙˆØ¬ Ù…Ù† Ø§Ù„Ù„Ø¹Ø¨Ø©",
                confirmExit: "Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ø£Ù†Ùƒ ØªØ±ÙŠØ¯ Ø§Ù„Ø®Ø±ÙˆØ¬ØŸ",
                yes: "Ù†Ø¹Ù…",
                no: "Ù„Ø§"
            }
        };

        const campaign = [
            { 
                bg: 'bg-cave', 
                enemyImg: 'troll.png',
                questions: [
                    { 
                        en: "I WILL NOT LET YOU FREE HER! NOW TELL ME: How do you PRINT in a programming language?", 
                        ar: "Ù„Ù† Ø£Ø³Ù…Ø­ Ù„Ùƒ Ø¨ØªØ­Ø±ÙŠØ±Ù‡Ø§! Ø£Ø®Ø¨Ø±Ù†ÙŠ Ø§Ù„Ø¢Ù†: ÙƒÙŠÙ ØªÙ‚ÙˆÙ… Ø¨Ù€ 'Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©' (PRINT) ÙÙŠ Ø§Ù„Ø¨Ø±Ù…Ø¬Ø©ØŸ",
                        a: "print", 
                        h1: { en: "Think of a printer.", ar: "ÙÙƒØ± ÙÙŠ Ø§Ù„Ø·Ø§Ø¨Ø¹Ø© Ø¨Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©" }, 
                        h2: { en: "Starts with 'p'.", ar: "'p'ØªØ¨Ø¯Ø£ Ø¨Ø­Ø±Ù " }, 
                        h3: { en: "p_i_t", ar: "p_i_t" } 
                    }, 
                    { 
                        en: "GOOD GUESS... BUT I BET YOU WON'T GET THIS ONE: Where do programmers STORE data?", 
                        ar: "ØªØ®Ù…ÙŠÙ† Ø¬ÙŠØ¯... Ù„ÙƒÙ† Ø£Ø±Ø§Ù‡Ù† Ø£Ù†Ùƒ Ù„Ù† ØªØ­Ù„ Ù‡Ø°Ù‡: Ø£ÙŠÙ† ÙŠØ®Ø²Ù† Ø§Ù„Ù…Ø¨Ø±Ù…Ø¬ÙˆÙ† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§ØªØŸ",
                        a: "variable", 
                        h1: { en: "Think of a container.", ar: "ÙÙƒØ± ÙÙŠ ÙˆØ¹Ø§Ø¡ Ø£Ùˆ Ø­Ø§ÙˆÙŠØ©." }, 
                        h2: { en: "It can 'vary'.", ar: "ÙŠÙ…ÙƒÙ† Ø£Ù† ØªØªØºÙŠØ± Ù‚ÙŠÙ…ØªÙ‡" }, 
                        h3: { en: "v_r_a_l_", ar: "v_r_a_l_" } 
                    }
                ] 
            },
            { 
                bg: 'bg-loope', 
                enemyImg: 'troll2.png',
                questions: [
                    { 
                        en: "I SEE YOU DEFEATED MY BROTHER, BUT I AM STRONGER! What is REPEATING code?", 
                        ar: "Ø£Ø±Ù‰ Ø£Ù†Ùƒ Ù‡Ø²Ù…Øª Ø£Ø®ÙŠØŒ Ù„ÙƒÙ†ÙŠ Ø£Ù‚ÙˆÙ‰ Ù…Ù†Ù‡! Ù…Ø§ Ù‡Ùˆ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ù…ØªÙƒØ±Ø± (REPEATING)ØŸ",
                        a: "loop", 
                        h1: { en: "Goes around.", ar: "ÙŠØ¯ÙˆØ± Ø­ÙˆÙ„ Ù†ÙØ³Ù‡." }, 
                        h2: { en: "Starts with 'l'.", ar: "ØªØ¨Ø¯Ø£ Ø¨Ø­Ø±Ù 'l'." }, 
                        h3: { en: "l_o_", ar: "l_o_" } 
                    }, 
                    { 
                        en: "NOW, WHAT IS A MISTAKE IN CODE CALLED?", 
                        ar: "Ø§Ù„Ø¢Ù†ØŒ Ù…Ø§Ø°Ø§ Ù†Ø³Ù…ÙŠ Ø§Ù„Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ÙƒÙˆØ¯ØŸ",
                        a: "bug", 
                        h1: { en: "An annoying insect.", ar: "Ø­Ø´Ø±Ø© Ù…Ø²Ø¹Ø¬Ø©." }, 
                        h2: { en: "Think of a beetle.", ar: "ÙÙƒØ± ÙÙŠ Ø®Ù†ÙØ³Ø§Ø¡." }, 
                        h3: { en: "b_g", ar: "b_g" } 
                    }
                ] 
            },
            { 
                bg: 'bg-mountain', 
                enemyImg: 'troll3.png',
                questions: [
                    { 
                        en: "ALMOST THERE... WHAT IS A REUSABLE BLOCK OF CODE?", 
                        ar: "Ø£Ù†Øª Ù‚Ø±ÙŠØ¨ Ø¬Ø¯Ø§Ù‹... Ù…Ø§ Ù‡ÙŠ Ù…Ø¬Ù…ÙˆØ¹Ø© Ø§Ù„Ø£ÙƒÙˆØ§Ø¯ Ø§Ù„Ù‚Ø§Ø¨Ù„Ø© Ù„Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…ØŸ",
                        a: "function", 
                        h1: { en: "A machine.", ar: "ØªØ¹Ù…Ù„ ÙƒØ¢Ù„Ø© ØªÙ‚ÙˆÙ… Ø¨Ù…Ù‡Ù…Ø©." }, 
                        h2: { en: "Starts with 'f'.", ar: "'f'ØªØ¨Ø¯Ø£ Ø¨Ø­Ø±Ù" }, 
                        h3: { en: "f_n_t_o_", ar: "f_n_t_o_" } 
                    }
                ] 
            },
            { 
                bg: 'bg-volcano', 
                enemyImg: 'boss.png',
                questions: [
                    { 
                        en: "NOO! I WILL MAKE SURE YOU DON'T GET THIS: WHAT ARE 1s AND 0s CALLED?", 
                        ar: "Ù„Ø§Ø§Ø§! Ø³Ø£Ø­Ø±Øµ Ø¹Ù„Ù‰ ÙØ´Ù„Ùƒ Ù‡Ù†Ø§: Ù…Ø§Ø°Ø§ ØªØ³Ù…Ù‰ Ù„ØºØ© Ø§Ù„Ù€ 0 ÙˆØ§Ù„Ù€ 1ØŸ",
                        a: "binary", 
                        h1: { en: "Computer language.", ar: "Ù„ØºØ© Ø§Ù„Ø­Ø§Ø³ÙˆØ¨ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©" }, 
                        h2: { en: "Bi- means two.", ar: "ÙƒÙ„Ù…Ø© ØªØ¹Ù†ÙŠ 'Ø«Ù†Ø§Ø¦ÙŠ'" }, 
                        h3: { en: "b_n_r_", ar: "b_n_r_" } 
                    }
                ] 
            }
        ];
    
        document.addEventListener('keydown', function(e) {
            if (e.key === "Enter") {
                if (!document.getElementById('level-window').classList.contains('hidden')) {
                    closeLevelWindow();
                } else if (!document.getElementById('intro-btn').classList.contains('hidden')) {
                    document.getElementById('intro-btn').click();
                } else if (document.getElementById('input-area').style.display === 'flex') {
                    handleAction();
                }
            }
        });

        function initAudio() {
            if (audioCtx) return;
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            gainNode = audioCtx.createGain();
            gainNode.connect(audioCtx.destination);
        }

        function playSfx(freq, type, duration, slide = false) {
            if (isMuted || !audioCtx) return;
            const osc = audioCtx.createOscillator();
            const g = audioCtx.createGain();
            osc.type = type;
            osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
            if(slide) osc.frequency.exponentialRampToValueAtTime(50, audioCtx.currentTime + duration);
            g.gain.setValueAtTime(0.1, audioCtx.currentTime);
            g.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + duration);
            osc.connect(g); g.connect(gainNode);
            osc.start(); osc.stop(audioCtx.currentTime + duration);
        }

        function startGame(l) {
            lang = l;
            applyTranslations(); 
            
            if (l === 'ar') {
                document.getElementById('ui-panel').classList.add('rtl');
                document.getElementById('lose-window').classList.add('rtl');
                document.getElementById('settings-window').classList.add('rtl');
                document.getElementById('confirm-window').classList.add('rtl');
                document.getElementById('settings-window').style.direction = "rtl";
            }
            initAudio();
            document.getElementById('start-screen').classList.add('hidden');
            updateHeartsUI();
            startIntro();
        }

        function applyTranslations() {
            const t = translations[lang];
            document.getElementById('attack-btn').innerText = t.attack;
            document.getElementById('replay-btn').innerText = t.replay;
            document.getElementById('exit-btn').innerText = t.exit;
            document.getElementById('main-settings-btn').innerText = t.settingsBtn;
            document.getElementById('settings-title').innerText = t.settingsTitle;
            document.getElementById('modal-mute-btn').innerText = isMuted ? t.soundOff : t.soundOn;
            document.getElementById('modal-exit-btn').innerText = t.exitGame;
            document.getElementById('modal-resume-btn').innerText = t.resume;
            document.getElementById('confirm-text').innerText = t.confirmExit;
            document.getElementById('confirm-yes-btn').innerText = t.yes;
            document.getElementById('confirm-no-btn').innerText = t.no;
            document.getElementById('lose-title').innerText = t.loseTitle;
            document.getElementById('lose-text').innerText = t.loseMsg;
            document.getElementById('lose-try-btn').innerText = t.tryAgain;
            document.getElementById('lose-exit-btn').innerText = t.exit;
        }

        function startIntro() {
            const sage = document.getElementById('sage');
            sage.style.display = 'block';
            sage.style.animation = 'slideInSage 2s forwards';
            talkStep = 0; 
            document.getElementById('speaker').innerText = translations[lang].wizard;
            document.getElementById('story-text').innerText = lang === 'ar' ? "Ø£ÙŠÙ‡Ø§ Ø§Ù„Ø¨Ø·Ù„! Ù…Ø§Ø°Ø§ ØªÙØ¹Ù„ Ø¨Ø­Ù‚ Ø§Ù„Ø³Ù…Ø§Ø¡ØŸ" : "HERO! What on earth are you doing?!";
            const btn = document.getElementById('intro-btn');
            btn.classList.remove('hidden');
            btn.innerText = translations[lang].next; 
            btn.onclick = explainIntro; 
        }

        function explainIntro() {
            const dialogueEN = [
                { s: "HERO", t: "Oh, hi Wizard! Long time no see! How have you been?" },
                { s: "WIZARD", t: "STOP CHATTING! The Giant has kidnapped the Princess!" },
                { s: "HERO", t: "WHAT?! Why didn't you tell me from the beginning?!" },
                { s: "WIZARD", t: "I WAS TRYING TO! But you wouldn't stop talking! Now, let's go!" }
            ];
            const dialogueAR = [
                { s: "Ø§Ù„Ø¨Ø·Ù„", t: "Ø£ÙˆÙ‡ØŒ Ø£Ù‡Ù„Ø§Ù‹ Ø£ÙŠÙ‡Ø§ Ø§Ù„Ø³Ø§Ø­Ø±! Ù„Ù… Ù†Ù„ØªÙ‚Ù Ù…Ù†Ø° Ø²Ù…Ù†! ÙƒÙŠÙ Ø­Ø§Ù„ÙƒØŸ" },
                { s: "Ø§Ù„Ø³Ø§Ø­Ø±", t: "ØªÙˆÙ‚Ù Ø¹Ù† Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©! Ù„Ù‚Ø¯ Ø§Ø®ØªØ·Ù Ø§Ù„Ø¹Ù…Ù„Ø§Ù‚ Ø§Ù„Ø£Ù…ÙŠØ±Ø©!" },
                { s: "Ø§Ù„Ø¨Ø·Ù„", t: "Ù…Ø§Ø°Ø§ØŸ! Ù„Ù…Ø§Ø°Ø§ Ù„Ù… ØªØ®Ø¨Ø±Ù†ÙŠ Ù…Ù†Ø° Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©ØŸ!" },
                { s: "Ø§Ù„Ø³Ø§Ø­Ø±", t: "Ù„Ù‚Ø¯ ÙƒÙ†Øª Ø£Ø­Ø§ÙˆÙ„! Ù„ÙƒÙ†Ùƒ Ù„Ù… ØªØªÙˆÙ‚Ù Ø¹Ù† Ø§Ù„ÙƒÙ„Ø§Ù…! Ø§Ù„Ø¢Ù†ØŒ Ù„Ù†Ù†Ø·Ù„Ù‚!" }
            ];
            const active = lang === 'ar' ? dialogueAR : dialogueEN;
            if (talkStep < active.length) {
                document.getElementById('speaker').innerText = active[talkStep].s + ":";
                document.getElementById('story-text').innerText = active[talkStep].t;
                if(talkStep === 0 || talkStep === 2) {
                     const hero = document.getElementById('hero');
                     hero.classList.add('hero-jump');
                     playSfx(600, 'sine', 0.2); 
                     setTimeout(() => hero.classList.remove('hero-jump'), 500);
                }
                talkStep++;
                if (talkStep === active.length) {
                    document.getElementById('intro-btn').innerText = translations[lang].go;
                }
            } else {
                triggerMissionStart();
            }
        }

        function triggerMissionStart() {
            playSfx(150, 'square', 0.2);
            document.getElementById('intro-btn').classList.add('hidden');
            document.getElementById('hero').classList.add('hero-jump');
            setTimeout(showLevelWindow, 600);
        }

        function showLevelWindow() {
            let msg = translations[lang]['level' + (stage + 1)];
            document.getElementById('level-title').innerText = msg;
            document.getElementById('level-window').classList.remove('hidden');
        }

        function closeLevelWindow() {
            document.getElementById('level-window').classList.add('hidden');
            const s = document.getElementById('sage');
            s.style.display = 'block';
            s.style.backgroundImage = "url('guardian_battle.png')";
            s.style.right = 'auto'; s.style.left = '40px'; s.style.bottom = '160px';
            s.style.width = '140px'; s.style.height = '140px';
            s.classList.add('flying');
            startWalking();
        }

        function startWalking() {
            const enemy = document.getElementById('enemy');
            const scene = document.getElementById('scene');
            const hero = document.getElementById('hero');
            enemy.style.display = 'none';
            hero.classList.add('walking-knight');
            scene.classList.add('scrolling');
            scene.className = campaign[stage].bg + ' scrolling'; 
            enemy.style.backgroundImage = `url('${campaign[stage].enemyImg}')`;
            document.getElementById('input-area').style.display = 'none';
            document.getElementById('hint-text').innerHTML = "";
            document.getElementById('speaker').innerText = translations[lang].system;
            document.getElementById('story-text').innerText = translations[lang].walking;
            setTimeout(() => {
                hero.classList.remove('walking-knight');
                scene.classList.remove('scrolling');
                enemy.style.display = 'block';
                document.getElementById('input-area').style.display = 'flex';
                document.getElementById('player-input').focus();
                updateQuestion();
            }, 2000);
        }

        function updateQuestion() {
            const qData = campaign[stage].questions[subStep];
            const t = translations[lang];
            document.getElementById('speaker').innerText = t.giant;
            document.getElementById('story-text').innerText = lang === 'ar' ? qData.ar : qData.en;
            
            let hContainer = document.getElementById('hint-text');
            hContainer.innerHTML = "";
            
        
            let h1 = document.createElement('div');
            h1.innerText = t.h1_label + qData.h1[lang];
            hContainer.appendChild(h1);

           
            if (hp <= 2) {
                let h2 = document.createElement('div');
                h2.innerText = t.h2_label + qData.h2[lang];
                hContainer.appendChild(h2);
            }
           
            if (hp <= 1) {
                let h3 = document.createElement('div');
                h3.innerText = t.h3_label + qData.h3[lang];
                hContainer.appendChild(h3);
            }
        }

        function handleAction() {
            const input = document.getElementById('player-input');
            const val = input.value.toLowerCase().trim();
            const correct = campaign[stage].questions[subStep].a;
            const enemy = document.getElementById('enemy');
            const hero = document.getElementById('hero');
            const container = document.getElementById('game-container');

            if (hero.classList.contains('fallen') || hero.style.transform.includes('300px')) return;

            if (val === correct) {
                hero.style.transform = "translateX(300px)"; 
                playSfx(440, 'sawtooth', 0.2); 
                setTimeout(() => {
                    hero.style.transform = "translateX(0)";
                    enemy.classList.add('fallen'); 
                    playSfx(150, 'sine', 0.5); 
                    setTimeout(() => {
                        enemy.classList.remove('fallen');
                        subStep++; 
                        if (subStep >= campaign[stage].questions.length) {
                            stage++;
                            subStep = 0;
                            if (stage >= campaign.length) {
                                startEnding();
                            } else {
                                showLevelWindow(); 
                            }
                        } else {
                            updateQuestion(); 
                        }
                    }, 1000); 
                }, 400);
            } else {
                enemy.style.transform = "translateX(-250px)"; 
                playSfx(150, 'sawtooth', 0.4); 
                setTimeout(() => {
                    enemy.style.transform = "translateX(0)"; 
                    hero.classList.add('fallen'); 
                    container.classList.add('shake-screen');
                    hp--;
                    updateHeartsUI();
                    setTimeout(() => {
                        hero.classList.remove('fallen'); 
                        container.classList.remove('shake-screen');
                        if (hp <= 0) {
                            document.getElementById('lose-window').classList.remove('hidden');
                        } else {
                            updateQuestion();
                            input.value = "";
                            input.focus(); 
                        }
                    }, 1200); 
                }, 300);
            }
            input.value = "";
        }

        function updateHeartsUI() {
            document.getElementById('hearts-display').style.backgroundImage = `url('hearts${hp}.png')`;
        }

        function startEnding() {
            [523, 659, 783, 1046].forEach((f, i) => setTimeout(() => playSfx(f, 'square', 0.4), i * 150));
            document.getElementById('scene').className = 'bg-castle';
            document.getElementById('enemy').style.display = 'none';
            document.getElementById('princess').style.display = 'block';
            document.getElementById('hero').style.bottom = "-40px";
            document.getElementById('princess').style.bottom = "-40px";
            document.getElementById('sage').style.bottom = "-4.5 px";
            document.getElementById('hero').style.left = "250px";
            document.getElementById('speaker').innerText = translations[lang].princess;
            document.getElementById('input-area').style.display = 'none';
            document.getElementById('hint-text').style.display = 'none';
            talkStep = 0;
            const btn = document.getElementById('intro-btn');
            btn.classList.remove('hidden');
            btn.innerText = translations[lang].next;
            btn.onclick = explainSE;
            explainSE(); 
        }

        function explainSE() {
            const dialogueEN = [
                "Thank you, Hero! Do you know what makes all this software work?",
                "It's Software Engineering! It's like being an architect for a digital city.",
                "First, we define a PROBLEM (like a bridge that needs building).",
                "Then we DESIGN the solution so it's safe, strong, and scalable.",
                "CODING is just the construction work. The real magic is the logic behind it!",
                "In high school terms: If you build an app, SE is the plan that makes sure 1 million people can use it at once without it breaking.",
                "You just mastered the logic foundations. The world needs more engineers like you!"
            ];
            const dialogueAR = [
                "Ø´ÙƒØ±Ø§Ù‹ Ù„Ùƒ Ø£ÙŠÙ‡Ø§Ø§Ù„Ø¨Ø·Ù„! Ù‡Ù„ ØªØ¹Ø±Ù Ù…Ø§ Ø§Ù„Ø°ÙŠ ÙŠØ¬Ø¹Ù„ ÙƒÙ„ Ù‡Ø°Ù‡ Ø§Ù„Ø¨Ø±Ø§Ù…Ø¬ ØªØ¹Ù…Ù„ØŸ",
                "Ø¥Ù†Ù‡Ø§ Ù‡Ù†Ø¯Ø³Ø© Ø§Ù„Ø¨Ø±Ù…Ø¬ÙŠØ§Øª! Ø¥Ù†Ù‡Ø§ Ù…Ø«Ù„ ÙƒÙˆÙ†Ùƒ Ù…Ù‡Ù†Ø¯Ø³Ø§Ù‹ Ù…Ø¹Ù…Ø§Ø±ÙŠØ§Ù‹ Ù„Ù…Ø¯ÙŠÙ†Ø© Ø±Ù‚Ù…ÙŠØ©.",
                "Ø£ÙˆÙ„Ø§Ù‹ØŒ Ù†Ø­Ø¯Ø¯ Ø§Ù„Ù…Ø´ÙƒÙ„Ø© (Ù…Ø«Ù„ Ø¬Ø³Ø± ÙŠØ­ØªØ§Ø¬ Ø¥Ù„Ù‰ Ø¨Ù†Ø§Ø¡).",
                "Ø«Ù… Ù†Ù‚ÙˆÙ… Ø¨ØªØµÙ…ÙŠÙ… Ø§Ù„Ø­Ù„ Ù„ÙŠÙƒÙˆÙ† Ø¢Ù…Ù†Ø§Ù‹ ÙˆÙ‚ÙˆÙŠØ§Ù‹ ÙˆÙ‚Ø§Ø¨Ù„Ø§Ù‹ Ù„Ù„ØªÙˆØ³Ø¹.",
                "Ø§Ù„Ø¨Ø±Ù…Ø¬Ø© Ù‡ÙŠ Ù…Ø¬Ø±Ø¯ Ø£Ø¹Ù…Ø§Ù„ Ø§Ù„Ø¨Ù†Ø§Ø¡. Ø§Ù„Ø³Ø­Ø± Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ Ù‡Ùˆ Ø§Ù„Ù…Ù†Ø·Ù‚ Ø§Ù„ÙƒØ§Ù…Ù† ÙˆØ±Ø§Ø¡Ù‡Ø§!",
                "Ø¨Ù…ØµØ·Ù„Ø­Ø§Øª Ø§Ù„Ù…Ø¯Ø±Ø³Ø©: Ø¥Ø°Ø§ Ù‚Ù…Øª Ø¨Ø¨Ù†Ø§Ø¡ ØªØ·Ø¨ÙŠÙ‚ØŒ ÙØ¥Ù† Ù‡Ù†Ø¯Ø³Ø© Ø§Ù„Ø¨Ø±Ù…Ø¬ÙŠØ§Øª Ù‡ÙŠ Ø§Ù„Ø®Ø·Ø© Ø§Ù„ØªÙŠ ØªØ¶Ù…Ù† Ø£Ù† Ù…Ù„ÙŠÙˆÙ† Ø´Ø®Øµ ÙŠÙ…ÙƒÙ†Ù‡Ù… Ø§Ø³ØªØ®Ø¯Ø§Ù…Ù‡ ÙÙŠ Ù†ÙØ³ Ø§Ù„ÙˆÙ‚Øª Ø¯ÙˆÙ† ØªÙˆÙ‚Ù!",
                "Ù„Ù‚Ø¯ Ø£ØªÙ‚Ù†Øª Ù„Ù„ØªÙˆ Ø£Ø³Ø§Ø³ÙŠØ§Øª Ø§Ù„Ù…Ù†Ø·Ù‚. Ø§Ù„Ø¹Ø§Ù„Ù… ÙŠØ­ØªØ§Ø¬ Ø¥Ù„Ù‰ Ø§Ù„Ù…Ø²ÙŠØ¯ Ù…Ù† Ø§Ù„Ù…Ù‡Ù†Ø¯Ø³ÙŠÙ† Ù…Ø«Ù„Ùƒ!"
            ];
            const active = lang === 'ar' ? dialogueAR : dialogueEN;
            if (talkStep < active.length) {
                document.getElementById('story-text').innerText = active[talkStep];
                talkStep++;
            } else {
                document.getElementById('story-text').innerText = lang === 'ar' ? "Ø§Ù„Ù†Ù‡Ø§ÙŠØ©... Ø´ÙƒØ±Ø§Ù‹ Ù„Ù„Ø¹Ø¨" : "The End... Thank you for playing!";
                document.getElementById('intro-btn').classList.add('hidden');
                document.getElementById('final-buttons').style.display = 'flex';
            }
        }

        function openSettings() {
            document.getElementById('settings-window').classList.remove('hidden');
        }

        function closeSettings() {
            document.getElementById('settings-window').classList.add('hidden');
        }

        function toggleMute() {
            isMuted = !isMuted;
            const btn = document.getElementById('modal-mute-btn');
            const t = translations[lang];
            if(btn) btn.innerText = isMuted ? t.soundOff : t.soundOn;
            if (gainNode) gainNode.gain.value = isMuted ? 0 : 1;
        }

        function askExit() {
            document.getElementById('settings-window').classList.add('hidden');
            document.getElementById('confirm-window').classList.remove('hidden');
        }

        function closeConfirm() {
            document.getElementById('confirm-window').classList.add('hidden');
            document.getElementById('settings-window').classList.remove('hidden');
        }

    
    const urlParams = new URLSearchParams(window.location.search);
    const returnUrl = urlParams.get('returnTo');
    function realExit() {
        if (returnUrl) {
    
            const target = decodeURIComponent(returnUrl);
            
            const separator = target.includes('?') ? '&' : '?';
            window.location.href = target + separator + "fromGame=true";
        } else {
            window.location.href = "index.html";
        }
    }
    function closeConfirm() {
        document.getElementById('confirm-window').classList.add('hidden');
    }


        function exitGame() {
            askExit();
        }
    </script>
    </body>
</html>